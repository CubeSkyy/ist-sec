package com.dpas.server;

/* these are generated by the hello-world-server contract */
import com.dpas.HelloWorld;
import com.dpas.HelloWorldServiceGrpc;
import io.grpc.Grpc;
import io.grpc.Status;
import io.grpc.stub.StreamObserver;

import java.io.File;
import java.io.IOException;
import java.io.FileOutputStream;
import java.io.ObjectOutputStream;
import java.io.FileInputStream;
import java.io.ObjectInputStream;
import java.util.*;

public class HelloWorldServiceImpl extends HelloWorldServiceGrpc.HelloWorldServiceImplBase {

	public static final String USERS_FILE = "users.tmp";
	public static final String PARTICULAR_FILE = "particular.tmp";
	public static final String GENERAL_FILE = "general.tmp";
	public static  final String MSG_USERS = "Users successfully written to file.";
	public static  final String MSG_PARTICULAR = "Particular post successfully written to file.";
	public static  final String MSG_GENERAL = "General post successfully written to file.";

	public void checkFile(String filename) {

		File f = new File(filename);
		System.out.println("File " + filename + " exists: " + f.isFile());

		if (!f.isFile()) {
			try {
				f.createNewFile();
				switch (filename) {
					case USERS_FILE:
						writeToFile(new HashMap<String, String>(), USERS_FILE, MSG_USERS);
						break;

					case PARTICULAR_FILE:
						writeToFile(new HashMap<String, ArrayList<HelloWorld.Announcement>>(), PARTICULAR_FILE, MSG_PARTICULAR);
						break;

					case GENERAL_FILE:
						writeToFile(new ArrayList<HelloWorld.Announcement>(), GENERAL_FILE, MSG_GENERAL);
						break;

					default:
						System.err.println("Invalid filename. Could not write to file.");
						break;
				}

				System.out.println("" + filename + " file not found. New instance has been created.");

			} catch (IOException e) {
				e.printStackTrace();
			}
		}
	}

	public void writeToFile(Object users, String type, String msg) {

		try {
			FileOutputStream fos = new FileOutputStream(type);
			ObjectOutputStream oos = new ObjectOutputStream(fos);
			oos.writeObject(users);
			System.out.println(msg);
			oos.close();

		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	public Object readFromFile(String type, String msg) {

		try {
			FileInputStream fis = new FileInputStream(type);
			ObjectInputStream ois = new ObjectInputStream(fis);
			Object users = ois.readObject();
			System.out.println(msg);
			ois.close();
			return users;

		} catch (Exception e) {
			e.printStackTrace();
		}
		return new Object();
	}

	@Override
	public void greeting(HelloWorld.HelloRequest request, StreamObserver<HelloWorld.HelloResponse> responseObserver) {

		// HelloRequest has auto-generated toString method that shows its contents
		System.out.println(request);

		// You must use a builder to construct a new Protobuffer object
		HelloWorld.HelloResponse response = HelloWorld.HelloResponse.newBuilder()
				.setGreeting("Hello " + request.getName()).build();

		// Use responseObserver to send a single response back
		responseObserver.onNext(response);

		// When you are done, you must call onCompleted
		responseObserver.onCompleted();
	}

	@Override
	public synchronized void register(HelloWorld.RegisterRequest request, StreamObserver<HelloWorld.RegisterResponse> responseObserver) {

		// HelloRequest has auto-generated toString method that shows its contents
		System.out.println(request);

		String key = request.getKey();

		/*
			TODO check if public key is owned by user with a digital signature
		*/

		checkFile(USERS_FILE);

		HashMap<String, String> users = (HashMap<String, String>) readFromFile(USERS_FILE, MSG_USERS);
		System.out.println("Class of retrieved info: " + users.getClass().getName());

		if (!users.containsKey(key)) {

			users.put(key, request.getUsername());
			writeToFile(users, USERS_FILE, MSG_USERS);
		}

		else
			System.out.println("User is already registered.");

		System.out.println("Users: " + users);


		// You must use a builder to construct a new Protobuffer object
		HelloWorld.RegisterResponse response = HelloWorld.RegisterResponse.newBuilder()
				.setResult(true).build();

		// Use responseObserver to send a single response back
		responseObserver.onNext(response);

		// When you are done, you must call onCompleted
		responseObserver.onCompleted();
	}

	@Override
	public synchronized void post(HelloWorld.PostRequest request, StreamObserver<HelloWorld.PostResponse> responseObserver) {

		// HelloRequest has auto-generated toString method that shows its contents
		System.out.println(request);

		HelloWorld.Announcement post = request.getPost();
		//List<HelloWorld.Announcement> a = post.getAList();
		System.out.println("A: " + post.getAList());

		String key = post.getKey();
		String message = post.getMessage();
		String signature = post.getSignature();

		if (message.length() > 255) {
			Status status = Status.INVALID_ARGUMENT;
			status = status.withDescription("Invalid message length. Message needs to be smaller than 255 characters.");
			responseObserver.onError(status.asRuntimeException());
		}


		/*
		TODO check if key is registered to a user
		TODO check if signature corresponds to message+announcement
		 */

		checkFile(PARTICULAR_FILE);

		HashMap<String, ArrayList<HelloWorld.Announcement>> particular = (HashMap<String, ArrayList<HelloWorld.Announcement>>) readFromFile(PARTICULAR_FILE, MSG_PARTICULAR);
		System.out.println("Class of retrieved info: " + particular.getClass().getName());

		if (!particular.containsKey(key)) {
			ArrayList<HelloWorld.Announcement> tmp = new ArrayList<HelloWorld.Announcement>();
			tmp.add(post);
			particular.put(key, tmp);
		}

		else {
			ArrayList<HelloWorld.Announcement> tmp = particular.get(key);
			tmp.add(post);
			particular.replace(key, tmp);
		}

		writeToFile(particular, PARTICULAR_FILE, MSG_PARTICULAR);

		System.out.println("Particular posts: " + particular);


		// You must use a builder to construct a new Protobuffer object
		HelloWorld.PostResponse response = HelloWorld.PostResponse.newBuilder()
				.setResult(true).build();

		// Use responseObserver to send a single response back
		responseObserver.onNext(response);

		// When you are done, you must call onCompleted
		responseObserver.onCompleted();
	}


	@Override
	public synchronized void postGeneral(HelloWorld.PostGeneralRequest request, StreamObserver<HelloWorld.PostGeneralResponse> responseObserver) {

		// HelloRequest has auto-generated toString method that shows its contents
		System.out.println(request);

		HelloWorld.Announcement post = request.getPost();
		//List<HelloWorld.Announcement> a = post.getAList();
		System.out.println("A: " + post.getAList());

		String key = post.getKey();
		String message = post.getMessage();
		String signature = post.getSignature();

		if (message.length() > 255) {
			Status status = Status.INVALID_ARGUMENT;
			status = status.withDescription("Invalid message length. Message needs to be smaller than 255 characters.");
			responseObserver.onError(status.asRuntimeException());
		}
		/*
		TODO check if key is registered to a user
		TODO check if signature corresponds to message+announcement
		 */

			checkFile(GENERAL_FILE);

			ArrayList<HelloWorld.Announcement> general = (ArrayList<HelloWorld.Announcement>) readFromFile(GENERAL_FILE, MSG_GENERAL);
			System.out.println("Class of retrieved info: " + general.getClass().getName());

			general.add(post);

			writeToFile(general, GENERAL_FILE, MSG_GENERAL);

			System.out.println("General posts: " + general);


			// You must use a builder to construct a new Protobuffer object
			HelloWorld.PostGeneralResponse response = HelloWorld.PostGeneralResponse.newBuilder()
					.setResult(true).build();

			// Use responseObserver to send a single response back
			responseObserver.onNext(response);

			// When you are done, you must call onCompleted
			responseObserver.onCompleted();

	}

	public synchronized void read(HelloWorld.ReadRequest request, StreamObserver<HelloWorld.ReadResponse> responseObserver) {

		// HelloRequest has auto-generated toString method that shows its contents
		System.out.println(request);

		//TODO

		// You must use a builder to construct a new Protobuffer object
		//HelloWorld.ReadResponse response = HelloWorld.ReadResponse.newBuilder().setResult().build();

		// Use responseObserver to send a single response back
		//responseObserver.onNext(response);

		// When you are done, you must call onCompleted
		responseObserver.onCompleted();
	}

	public synchronized void readGeneral(HelloWorld.ReadGeneralRequest request, StreamObserver<HelloWorld.ReadGeneralResponse> responseObserver) {

		// HelloRequest has auto-generated toString method that shows its contents
		System.out.println(request);

		//TODO

		// You must use a builder to construct a new Protobuffer object
		//HelloWorld.ReadResponse response = HelloWorld.ReadResponse.newBuilder().setResult().build();

		// Use responseObserver to send a single response back
		//responseObserver.onNext(response);

		// When you are done, you must call onCompleted
		responseObserver.onCompleted();
	}

}
